<?php

// phpcs:disable

use Nether\Atlantis;
use Nether\Avenue;
use Nether\Blog;
use Nether\Common;
use Nether\Surface;
use Nether\User;

/**
 * @var Atlantis\Engine $App
 * @var Atlantis\Struct\TemplateHelper $Util
 * @var Avenue\Router $Router
 * @var Surface\Engine $Surface
 * @var User\EntitySession $User
 *
 * @var Atlantis\PublicWeb $Route
 * @var Blog\BlogUser $BlogUser
 * @var Blog\Blog $Blog
 * @var Blog\Post $Post
 */


$GenerateBlogUserMenu = function(Atlantis\Engine $App, Blog\Post $Post) {

	$Menu = Atlantis\Struct\DropdownMenu::New();
	$Break = [ [ 'Title' => '-' ] ];
	$Items = NULL;
	$Item = NULL;

	// the menu has various sections that will likely need to be hooked onto
	// separately so things can be added and sorted within their subgroups.

	$PostItems = Common\Datastore::FromArray([
		[ 'Title' => 'Edit Post', 'Icon' => 'mdi-pencil', 'URL' => $Post->GetEditURL() ],
		[ 'Title' => 'Edit Tags', 'Icon' => 'mdi-tag-multiple', 'Attr' => $Post->GetDataAttr([ 'post-cmd'=> 'tags' ], TRUE) ],
		[ 'Title' => 'Link Profiles...', 'Icon' => 'mdi-tag-multiple', 'Attr' => $Post->GetDataAttr([ 'profile-cmd'=> 'erlink', 'parent-type'=> 'Blog.Post' ], TRUE) ]
	]);

	$ActionItems = Common\Datastore::FromArray([
		[ 'Title' => 'Add Video URL', 'Icon' => 'mdi-video', 'Attr' => $Post->GetDataAttr([ 'videotp-cmd'=> 'new', 'parent-type'=> Blog\Key::EntityTypePost, 'parent-uuid'=> $Post->UUID ], TRUE) ],
		[ 'Title' => 'Upload Photos', 'Icon' => 'mdi-image', 'Attr' => $Post->GetDataAttr([ 'photolib-cmd'=> 'upload', 'parent-type'=> Blog\Key::EntityTypePost, 'parent-uuid'=> $Post->UUID ], TRUE) ]
	]);

	$PrivacyItems = Common\Datastore::FromArray([
		[ 'Title' => 'Set to Draft Mode', 'Icon' => 'mdi-eye-off', 'Attr' => $Post->GetDataAttr([ 'post-cmd'=> 'draft' ], TRUE), 'If' => $Post->Enabled ],
		[ 'Title' => 'Set to Published Mode', 'Icon' => 'mdi-eye', 'Attr' => $Post->GetDataAttr([ 'post-cmd'=> 'publish' ], TRUE), 'If' => !$Post->Enabled ]
	]);

	$FinalItems = Common\Datastore::FromArray([
		[ 'Title' => 'Delete Post', 'Icon' => 'mdi-trash-can', 'Attr' => $Post->GetDataAttr([ 'post-cmd'=> 'delete' ], TRUE), 'Warn' => Atlantis\Struct\DropdownItem::Danger ]
	]);

	// apply any additional menu items from website plugins and then sort
	// those subgroups.

	($App->Plugins->Get(Blog\Plugins\BlogPostWriterMenuInterface::class))
	->Remap(fn(string $ClassName)=> new $ClassName($App))
	->Each(function(Blog\Plugins\BlogPostWriterMenuInterface $P) use($App, $Post, $ActionItems) {
		$ActionItems->MergeRight($P->GetActionItems($App, $Post));
		return;
	});

	$ActionItems->Sort(fn($A, $B)=> $A['Title'] <=> $B['Title']);

	// compile the final menu from all of the sections. dont sort this set
	// because the subsets have all been managed.

	$Items = Common\Datastore::FromStackMerged(
		$PostItems, $Break,
		$ActionItems, $Break,
		$PrivacyItems, $Break,
		$FinalItems
	);

	foreach($Items as $Item)
	$Menu->ItemNew(...$Item);

	return $Menu;
};

$BlogUserMenu = match(TRUE) {
	($BlogUser && $BlogUser->CanWrite())
	=> $GenerateBlogUserMenu($App, $Post),

	default
	=> NULL
};


?>

<hr id="PostInfo" class="d-none"
data-blog-id="<?php $Util->Print($Post->Blog->ID) ?>"
data-blog-uuid="<?php $Util->Print($Post->Blog->UUID) ?>"
data-post-id="<?php $Util->Print($Post->ID) ?>"
data-post-uuid="<?php $Util->Print($Post->UUID) ?>"
/>

<?php $Surface->Area('blog/widgets/blog-header', $__SCOPE) ?>

<div class="container pt-4 ">
	<div class="row align-items-center">

		<!-- POST TITLE -->
		<div class="col">
			<h2 class="text-uppercase">
				<a href="<?php $Util->Print($Blog->GetURL()) ?>"><?php $Util->Print($Blog->Title) ?></a>
			</h2>
		</div>

		<!-- EDIT CONTROLS -->
		<?php if($BlogUserMenu !== NULL): ?>
		<div class="col-auto">
			<?php echo Atlantis\UI\Dropdown::FromMenuStruct($Surface, $BlogUserMenu) ?>
		</div>
		<?php endif; ?>

	</div>
	<hr class="mt-1" />
</div>

<div class="pt-0 pb-4">
	<div class="container">

		<?php if(!$Post->Enabled): ?>
		<div class="alert alert-primary text-center p-2 mb-4">
			This post is in DRAFT mode.
		</div>
		<?php endif; ?>

		<?php
		match($Post->Editor) {
			'link'
			=> $Surface->Area('blog/views/link', $__SCOPE),

			default
			=> $Surface->Area('blog/views/html', $__SCOPE)
		};
		?>

		<?php if(isset($Photos) && $Photos->Total): ?>
		<!-- PHOTOS -->
		<div class="mb-8">
			<h4 class="text-uppercase mb-0">Photos (<?php $Util->Print($Photos->Total) ?>)</h4>
			<hr class="mt-1 mb-3" />

			<?php echo Atlantis\UI\Gallery::FromDataset($Surface, $Photos) ?>
		</div>
		<?php endif; ?>

		<?php if(isset($Videos) && $Videos->Total): ?>
		<!-- VIDEOS -->
		<div class="mb-8">
			<h4 class="text-uppercase mb-0">Videos (<?php $Util->Print($Videos->Total) ?>)</h4>
			<hr class="mt-1 mb-3" />

			<?php echo Atlantis\UI\VideoList::FromDataset($Surface, $Videos, ParentUUID: $Post->UUID) ?>
		</div>
		<?php endif; ?>

	</div>
</div>

<?php if($BlogUser && $BlogUser->CanEdit()): ?>
<script type="module">
import Blog from '/share/atlantis/blog.js';

jQuery(function(){
	let post = Blog.Post.FromElement({ bindify: true });
	return;
});

</script>
<?php endif; ?>
